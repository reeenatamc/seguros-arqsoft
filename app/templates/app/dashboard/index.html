{% extends 'app/layouts/base.html' %}
{% load static %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<!-- Contenedor de datos para JavaScript -->
<div id="dashboard-data" class="hidden"
    data-chart='{{ chart_data|safe }}'
    data-year-comparison='{{ year_comparison|safe }}'
    data-api-stats-url="{% url 'api_dashboard_filtered_stats' %}"
    data-api-charts-url="{% url 'api_dashboard_filtered_charts' %}"
    data-api-lists-url="{% url 'api_dashboard_filtered_lists' %}"
></div>

<div class="space-y-6" x-data="dashboardApp()">
    <!-- Encabezado con acciones -->
    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
        <div>
            <h1 class="text-2xl font-bold text-slate-800">Dashboard</h1>
            <p class="text-sm text-slate-500">
                <span x-text="dateRangeLabel">{{ stats.filters.date_label }}</span>
            </p>
        </div>
        
        <div class="flex flex-wrap items-center gap-3">
            <!-- Botón de filtros -->
            <button @click="showFilters = !showFilters" 
                    class="inline-flex items-center gap-2 px-4 py-2.5 rounded-xl text-sm font-medium transition-all
                           bg-white border border-slate-200 text-slate-700 hover:bg-slate-50 hover:border-slate-300 shadow-sm"
                    :class="{ 'bg-brand-50 border-brand-200 text-brand-700': showFilters || hasActiveFilters }">
                <i class="fas fa-filter text-xs"></i>
                Filtros
                <span x-show="activeFilterCount > 0" 
                      class="inline-flex items-center justify-center w-5 h-5 text-xs font-bold bg-brand-500 text-white rounded-full"
                      x-text="activeFilterCount"></span>
            </button>
            
            <!-- Selector rápido de fecha -->
            <div class="relative" x-data="{ open: false }">
                <button @click="open = !open" 
                        class="inline-flex items-center gap-2 px-4 py-2.5 rounded-xl text-sm font-medium transition-all
                               bg-white border border-slate-200 text-slate-700 hover:bg-slate-50 shadow-sm">
                    <i class="fas fa-calendar text-xs text-slate-400"></i>
                    <span x-text="selectedPresetLabel">{{ date_presets|dictsort:0|first|last }}</span>
                    <i class="fas fa-chevron-down text-xs text-slate-400"></i>
                </button>
                
                <div x-show="open" @click.away="open = false" x-transition
                     class="absolute right-0 mt-2 w-56 bg-white rounded-xl shadow-lg border border-slate-100 py-2 z-50">
                    {% for key, label in date_presets.items %}
                    <button @click="selectDatePreset('{{ key }}', '{{ label }}'); open = false"
                            class="w-full px-4 py-2 text-left text-sm hover:bg-slate-50 transition
                                   {% if filters.date_preset == key %}text-brand-600 font-medium bg-brand-50{% else %}text-slate-700{% endif %}">
                        {{ label }}
                    </button>
                    {% endfor %}
                </div>
            </div>
            
            <!-- Botón de exportar -->
            <div class="relative" x-data="{ open: false }">
                <button @click="open = !open"
                        class="inline-flex items-center gap-2 px-4 py-2.5 rounded-xl text-sm font-medium transition-all
                               bg-white border border-slate-200 text-slate-700 hover:bg-slate-50 shadow-sm">
                    <i class="fas fa-download text-xs text-slate-400"></i>
                    Exportar
                </button>
                
                <div x-show="open" @click.away="open = false" x-transition
                     class="absolute right-0 mt-2 w-48 bg-white rounded-xl shadow-lg border border-slate-100 py-2 z-50">
                    <a href="{% url 'api_dashboard_export' %}?{{ request.GET.urlencode }}" 
                       class="flex items-center gap-3 px-4 py-2 text-sm text-slate-700 hover:bg-slate-50">
                        <i class="fas fa-file-code text-slate-400"></i> Exportar JSON
                    </a>
                    <a href="{% url 'reportes_ejecutivo_pdf' %}" 
                       class="flex items-center gap-3 px-4 py-2 text-sm text-slate-700 hover:bg-slate-50">
                        <i class="fas fa-file-pdf text-red-500"></i> Reporte Ejecutivo PDF
                    </a>
                    <a href="{% url 'polizas_exportar' %}?formato=excel" 
                       class="flex items-center gap-3 px-4 py-2 text-sm text-slate-700 hover:bg-slate-50">
                        <i class="fas fa-file-excel text-emerald-500"></i> Pólizas Excel
                    </a>
                </div>
            </div>
            
            <!-- Botón de refrescar -->
            <button @click="refreshData()" 
                    class="inline-flex items-center justify-center w-10 h-10 rounded-xl text-slate-500 hover:text-slate-700 hover:bg-slate-100 transition"
                    :class="{ 'animate-spin': isLoading }">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
    </div>
    
    <!-- Panel de Filtros Avanzados (colapsable) -->
    <div x-show="showFilters" x-collapse x-cloak
         class="bg-white rounded-2xl shadow-card border border-slate-100 overflow-hidden">
        <div class="p-5 border-b border-slate-100 flex items-center justify-between">
            <h3 class="font-semibold text-slate-800 flex items-center gap-2">
                <i class="fas fa-sliders-h text-brand-500"></i>
                Filtros Avanzados
            </h3>
            <button @click="clearFilters()" class="text-sm text-slate-500 hover:text-red-600 transition">
                <i class="fas fa-times-circle mr-1"></i> Limpiar filtros
            </button>
        </div>
        
        <form id="filters-form" method="get" class="p-5">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- Rango de fechas personalizado -->
                <div class="lg:col-span-2">
                    <label class="block text-sm font-medium text-slate-700 mb-2">Rango de Fechas</label>
                    <div class="flex items-center gap-2">
                        <div class="relative flex-1">
                            <input type="date" name="date_from" x-model="dateFrom"
                                   class="w-full px-4 py-2.5 rounded-xl border border-slate-200 text-sm focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500"
                                   value="{{ filters.date_from|date:'Y-m-d' }}">
                        </div>
                        <span class="text-slate-400">→</span>
                        <div class="relative flex-1">
                            <input type="date" name="date_to" x-model="dateTo"
                                   class="w-full px-4 py-2.5 rounded-xl border border-slate-200 text-sm focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500"
                                   value="{{ filters.date_to|date:'Y-m-d' }}">
                        </div>
                    </div>
                    <input type="hidden" name="date_preset" x-model="datePreset" value="{{ filters.date_preset }}">
                </div>
                
                <!-- Búsqueda -->
                <div class="lg:col-span-2">
                    <label class="block text-sm font-medium text-slate-700 mb-2">Búsqueda</label>
                    <div class="relative">
                        <input type="text" name="q" 
                               class="w-full pl-10 pr-4 py-2.5 rounded-xl border border-slate-200 text-sm focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500"
                               placeholder="Buscar por número, nombre..."
                               value="{{ filters.search_query }}">
                        <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                    </div>
                </div>
                
                <!-- Compañía Aseguradora -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">Compañía Aseguradora</label>
                    <select name="insurer" 
                            class="w-full px-4 py-2.5 rounded-xl border border-slate-200 text-sm focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500">
                        <option value="">Todas las compañías</option>
                        {% for insurer in available_filters.insurers %}
                        <option value="{{ insurer.id }}" {% if insurer.id in filters.insurers %}selected{% endif %}>
                            {{ insurer.nombre }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Corredor -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">Corredor de Seguros</label>
                    <select name="broker" 
                            class="w-full px-4 py-2.5 rounded-xl border border-slate-200 text-sm focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500">
                        <option value="">Todos los corredores</option>
                        {% for broker in available_filters.brokers %}
                        <option value="{{ broker.id }}" {% if broker.id in filters.brokers %}selected{% endif %}>
                            {{ broker.nombre }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Tipo de Póliza -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">Tipo de Póliza</label>
                    <select name="policy_type" 
                            class="w-full px-4 py-2.5 rounded-xl border border-slate-200 text-sm focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500">
                        <option value="">Todos los tipos</option>
                        {% for type in available_filters.policy_types %}
                        <option value="{{ type.id }}" {% if type.id in filters.policy_types %}selected{% endif %}>
                            {{ type.nombre }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Estado de Póliza -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">Estado de Póliza</label>
                    <select name="policy_state" 
                            class="w-full px-4 py-2.5 rounded-xl border border-slate-200 text-sm focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500">
                        <option value="">Todos los estados</option>
                        {% for state in available_filters.policy_states %}
                        <option value="{{ state.value }}" {% if state.value in filters.policy_states %}selected{% endif %}>
                            {{ state.label }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <div class="flex items-center justify-end gap-3 mt-5 pt-5 border-t border-slate-100">
                <button type="button" @click="showFilters = false" 
                        class="px-4 py-2 text-sm text-slate-600 hover:text-slate-800 transition">
                    Cancelar
                </button>
                <button type="submit" 
                        class="px-6 py-2.5 bg-brand-600 hover:bg-brand-700 text-white text-sm font-medium rounded-xl transition shadow-sm">
                    <i class="fas fa-check mr-2"></i> Aplicar Filtros
                </button>
            </div>
        </form>
    </div>
    
    <!-- KPIs Principales con indicadores de tendencia -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 lg:gap-6">
        <!-- Pólizas Activas -->
        <div class="bg-white rounded-2xl shadow-card hover:shadow-card-hover p-6 border border-slate-100 relative overflow-hidden group transition-all">
            <div class="absolute top-0 right-0 w-28 h-28 bg-emerald-500/10 rounded-full -translate-y-1/2 translate-x-1/2 group-hover:scale-110 transition-transform"></div>
            <div class="relative">
                <div class="flex items-center justify-between mb-3">
                    <div class="w-12 h-12 bg-emerald-100 rounded-xl flex items-center justify-center">
                        <i class="fas fa-file-shield text-xl text-emerald-600"></i>
                    </div>
                    <span class="text-xs font-medium text-emerald-600 bg-emerald-100 px-2 py-1 rounded-full">
                        {{ stats.policies.active }} activas
                    </span>
                </div>
                <p class="text-3xl font-bold text-slate-800 mb-1">{{ stats.policies.total }}</p>
                <p class="text-sm text-slate-500">Pólizas en período</p>
                <div class="mt-3 pt-3 border-t border-slate-100 flex items-center justify-between text-xs">
                    <span class="text-amber-600">
                        <i class="fas fa-clock mr-1"></i> {{ stats.policies.expiring }} por vencer
                    </span>
                    <span class="text-red-600">
                        <i class="fas fa-times-circle mr-1"></i> {{ stats.policies.expired }} vencidas
                    </span>
                </div>
            </div>
        </div>
        
        <!-- Facturación -->
        <div class="bg-white rounded-2xl shadow-card hover:shadow-card-hover p-6 border border-slate-100 relative overflow-hidden group transition-all">
            <div class="absolute top-0 right-0 w-28 h-28 bg-blue-500/10 rounded-full -translate-y-1/2 translate-x-1/2 group-hover:scale-110 transition-transform"></div>
            <div class="relative">
                <div class="flex items-center justify-between mb-3">
                    <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                        <i class="fas fa-file-invoice-dollar text-xl text-blue-600"></i>
                    </div>
                    <span class="text-xs font-medium text-emerald-600 bg-emerald-100 px-2 py-1 rounded-full">
                        {{ stats.invoices.collection_rate }}% cobrado
                    </span>
                </div>
                <p class="text-3xl font-bold text-slate-800 mb-1">${{ stats.invoices.total_amount|floatformat:0 }}</p>
                <p class="text-sm text-slate-500">Facturado en período</p>
                <div class="mt-3 pt-3 border-t border-slate-100 flex items-center justify-between text-xs">
                    <span class="text-emerald-600">
                        <i class="fas fa-check-circle mr-1"></i> ${{ stats.invoices.paid_amount|floatformat:0 }}
                    </span>
                    <span class="text-amber-600">
                        <i class="fas fa-hourglass-half mr-1"></i> ${{ stats.invoices.pending_amount|floatformat:0 }}
                    </span>
                </div>
            </div>
        </div>
        
        <!-- Siniestros -->
        <div class="bg-white rounded-2xl shadow-card hover:shadow-card-hover p-6 border border-slate-100 relative overflow-hidden group transition-all">
            <div class="absolute top-0 right-0 w-28 h-28 bg-amber-500/10 rounded-full -translate-y-1/2 translate-x-1/2 group-hover:scale-110 transition-transform"></div>
            <div class="relative">
                <div class="flex items-center justify-between mb-3">
                    <div class="w-12 h-12 bg-amber-100 rounded-xl flex items-center justify-center">
                        <i class="fas fa-car-burst text-xl text-amber-600"></i>
                    </div>
                    <span class="text-xs font-medium text-blue-600 bg-blue-100 px-2 py-1 rounded-full">
                        {{ stats.claims.active }} activos
                    </span>
                </div>
                <p class="text-3xl font-bold text-slate-800 mb-1">{{ stats.claims.total }}</p>
                <p class="text-sm text-slate-500">Siniestros en período</p>
                <div class="mt-3 pt-3 border-t border-slate-100 flex items-center justify-between text-xs">
                    <span class="text-amber-600">
                        <i class="fas fa-file-alt mr-1"></i> {{ stats.claims.pending_docs }} sin docs
                    </span>
                    <span class="text-purple-600">
                        <i class="fas fa-search mr-1"></i> {{ stats.claims.in_evaluation }} evaluación
                    </span>
                </div>
            </div>
        </div>
        
        <!-- Alertas -->
        <div class="bg-white rounded-2xl shadow-card hover:shadow-card-hover p-6 border border-slate-100 relative overflow-hidden group transition-all">
            <div class="absolute top-0 right-0 w-28 h-28 bg-red-500/10 rounded-full -translate-y-1/2 translate-x-1/2 group-hover:scale-110 transition-transform"></div>
            <div class="relative">
                <div class="flex items-center justify-between mb-3">
                    <div class="w-12 h-12 bg-red-100 rounded-xl flex items-center justify-center">
                        <i class="fas fa-bell text-xl text-red-600"></i>
                    </div>
                    {% if stats.alerts.total_active > 0 %}
                    <span class="relative flex h-3 w-3">
                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span>
                    </span>
                    {% endif %}
                </div>
                <p class="text-3xl font-bold text-slate-800 mb-1">{{ stats.alerts.total_active }}</p>
                <p class="text-sm text-slate-500">Alertas Pendientes</p>
                <div class="mt-3 pt-3 border-t border-slate-100">
                    <a href="{% url 'alertas_lista' %}" class="inline-flex items-center gap-1 text-xs font-medium text-brand-600 hover:text-brand-700">
                        Ver alertas <i class="fas fa-arrow-right text-[10px]"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Acciones Rápidas -->
    <div class="bg-gradient-to-r from-slate-800 to-slate-900 rounded-2xl p-5 shadow-lg">
        <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold text-white flex items-center gap-2">
                <i class="fas fa-bolt text-amber-400"></i>
                Acciones Requeridas
            </h3>
            <span class="text-xs text-slate-400">Actualizado ahora</span>
        </div>
        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-3">
            <a href="{% url 'polizas_lista' %}?estado=por_vencer" 
               class="bg-white/10 hover:bg-white/20 rounded-xl p-4 transition-all text-center group">
                <div class="text-2xl font-bold text-amber-400 group-hover:scale-110 transition-transform">
                    {{ quick_actions.policies_expiring_soon }}
                </div>
                <div class="text-xs text-slate-300 mt-1">Vencen en 7 días</div>
            </a>
            <a href="{% url 'polizas_lista' %}?estado=por_vencer" 
               class="bg-white/10 hover:bg-white/20 rounded-xl p-4 transition-all text-center group">
                <div class="text-2xl font-bold text-yellow-400 group-hover:scale-110 transition-transform">
                    {{ quick_actions.policies_expiring_month }}
                </div>
                <div class="text-xs text-slate-300 mt-1">Vencen en 30 días</div>
            </a>
            <a href="{% url 'facturas_lista' %}?estado=vencida" 
               class="bg-white/10 hover:bg-white/20 rounded-xl p-4 transition-all text-center group">
                <div class="text-2xl font-bold text-red-400 group-hover:scale-110 transition-transform">
                    {{ quick_actions.overdue_invoices }}
                </div>
                <div class="text-xs text-slate-300 mt-1">Facturas vencidas</div>
            </a>
            <a href="{% url 'siniestros_lista' %}?estado=documentacion_pendiente" 
               class="bg-white/10 hover:bg-white/20 rounded-xl p-4 transition-all text-center group">
                <div class="text-2xl font-bold text-orange-400 group-hover:scale-110 transition-transform">
                    {{ quick_actions.pending_claims_docs }}
                </div>
                <div class="text-xs text-slate-300 mt-1">Sin documentos</div>
            </a>
            <a href="{% url 'siniestros_lista' %}?estado=enviado_aseguradora" 
               class="bg-white/10 hover:bg-white/20 rounded-xl p-4 transition-all text-center group">
                <div class="text-2xl font-bold text-purple-400 group-hover:scale-110 transition-transform">
                    {{ quick_actions.claims_awaiting_response }}
                </div>
                <div class="text-xs text-slate-300 mt-1">Sin respuesta (+8d)</div>
            </a>
        </div>
    </div>
    
    <!-- KPIs Financieros Globales -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 lg:gap-6">
        <div class="bg-gradient-to-br from-brand-600 to-brand-800 rounded-2xl p-5 text-white shadow-lg">
            <div class="flex items-center gap-3">
                <div class="w-11 h-11 bg-white/20 rounded-xl flex items-center justify-center backdrop-blur">
                    <i class="fas fa-shield-halved text-lg"></i>
                </div>
                <div>
                    <p class="text-xs text-white/70 uppercase tracking-wide">Suma Asegurada Total</p>
                    <p class="text-xl font-bold">${{ kpis.suma_total_asegurada|floatformat:0|default:"0" }}</p>
                </div>
            </div>
        </div>
        
        <div class="bg-gradient-to-br from-emerald-500 to-emerald-700 rounded-2xl p-5 text-white shadow-lg">
            <div class="flex items-center gap-3">
                <div class="w-11 h-11 bg-white/20 rounded-xl flex items-center justify-center backdrop-blur">
                    <i class="fas fa-coins text-lg"></i>
                </div>
                <div>
                    <p class="text-xs text-white/70 uppercase tracking-wide">Facturado Año</p>
                    <p class="text-xl font-bold">${{ kpis.total_facturado_anio|floatformat:0|default:"0" }}</p>
                </div>
            </div>
        </div>
        
        <div class="bg-gradient-to-br from-amber-500 to-orange-600 rounded-2xl p-5 text-white shadow-lg">
            <div class="flex items-center gap-3">
                <div class="w-11 h-11 bg-white/20 rounded-xl flex items-center justify-center backdrop-blur">
                    <i class="fas fa-hand-holding-dollar text-lg"></i>
                </div>
                <div>
                    <p class="text-xs text-white/70 uppercase tracking-wide">Indemnizado Año</p>
                    <p class="text-xl font-bold">${{ kpis.total_indemnizado_anio|floatformat:0|default:"0" }}</p>
                </div>
            </div>
        </div>
        
        <div class="bg-gradient-to-br from-purple-500 to-purple-700 rounded-2xl p-5 text-white shadow-lg">
            <div class="flex items-center gap-3">
                <div class="w-11 h-11 bg-white/20 rounded-xl flex items-center justify-center backdrop-blur">
                    <i class="fas fa-percent text-lg"></i>
                </div>
                <div>
                    <p class="text-xs text-white/70 uppercase tracking-wide">Siniestralidad</p>
                    <p class="text-xl font-bold">{{ kpis.tasa_siniestralidad|floatformat:1|default:"0" }}%</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Gráficos principales -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Tendencia de Facturación -->
        <div class="bg-white rounded-2xl shadow-card border border-slate-100 overflow-hidden">
            <div class="p-5 border-b border-slate-100 flex items-center justify-between">
                <div>
                    <h3 class="font-semibold text-slate-800">Tendencia de Facturación</h3>
                    <p class="text-sm text-slate-500">Según filtros aplicados</p>
                </div>
                <div class="flex items-center gap-3 text-xs">
                    <span class="flex items-center gap-1.5">
                        <span class="w-3 h-3 rounded-full bg-emerald-500"></span>
                        Facturado
                    </span>
                    <span class="flex items-center gap-1.5">
                        <span class="w-3 h-3 rounded-full bg-blue-500"></span>
                        Cobrado
                    </span>
                </div>
            </div>
            <div class="p-5">
                <canvas id="invoicingTrendChart" height="200"></canvas>
            </div>
        </div>
        
        <!-- Tendencia de Siniestros -->
        <div class="bg-white rounded-2xl shadow-card border border-slate-100 overflow-hidden">
            <div class="p-5 border-b border-slate-100 flex items-center justify-between">
                <div>
                    <h3 class="font-semibold text-slate-800">Tendencia de Siniestros</h3>
                    <p class="text-sm text-slate-500">Según filtros aplicados</p>
                </div>
            </div>
            <div class="p-5">
                <canvas id="claimsTrendChart" height="200"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Distribuciones -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Por Estado de Póliza -->
        <div class="bg-white rounded-2xl shadow-card border border-slate-100 overflow-hidden">
            <div class="p-5 border-b border-slate-100">
                <h3 class="font-semibold text-slate-800">Pólizas por Estado</h3>
            </div>
            <div class="p-5 flex items-center justify-center">
                <div class="w-full max-w-[200px]">
                    <canvas id="policyStateChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Por Compañía -->
        <div class="bg-white rounded-2xl shadow-card border border-slate-100 overflow-hidden">
            <div class="p-5 border-b border-slate-100">
                <h3 class="font-semibold text-slate-800">Top Compañías</h3>
            </div>
            <div class="p-5">
                <canvas id="byInsurerChart" height="200"></canvas>
            </div>
        </div>
        
        <!-- Siniestros por Tipo -->
        <div class="bg-white rounded-2xl shadow-card border border-slate-100 overflow-hidden">
            <div class="p-5 border-b border-slate-100">
                <h3 class="font-semibold text-slate-800">Siniestros por Tipo</h3>
            </div>
            <div class="p-5 flex items-center justify-center">
                <div class="w-full max-w-[200px]">
                    <canvas id="claimTypeChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Listas de Actividad -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Pólizas por Vencer -->
        <div class="bg-white rounded-2xl shadow-card border border-slate-100 overflow-hidden">
            <div class="p-5 border-b border-slate-100 flex items-center justify-between">
                <h3 class="font-semibold text-slate-800 flex items-center gap-2">
                    <i class="fas fa-calendar-xmark text-amber-500"></i>
                    Pólizas por Vencer
                </h3>
                <a href="{% url 'polizas_lista' %}?estado=por_vencer" class="text-sm font-medium text-brand-600 hover:text-brand-700">
                    Ver todas
                </a>
            </div>
            <div class="divide-y divide-slate-100 max-h-72 overflow-y-auto">
                {% for poliza in expiring_policies %}
                <div class="p-4 hover:bg-slate-50 transition">
                    <div class="flex items-center justify-between gap-3">
                        <div class="min-w-0">
                            <p class="font-medium text-slate-800 truncate">{{ poliza.numero_poliza }}</p>
                            <p class="text-xs text-slate-500 truncate">{{ poliza.compania_aseguradora__nombre }}</p>
                        </div>
                        <div class="text-right flex-shrink-0">
                            <span class="inline-flex items-center gap-1 px-2 py-1 bg-amber-100 text-amber-700 rounded-full text-xs font-semibold">
                                {{ poliza.days_to_expire }}d
                            </span>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="p-6 text-center text-slate-500">
                    <i class="fas fa-check-circle text-3xl text-emerald-400 mb-2"></i>
                    <p class="text-sm">Sin pólizas por vencer</p>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- Facturas Pendientes -->
        <div class="bg-white rounded-2xl shadow-card border border-slate-100 overflow-hidden">
            <div class="p-5 border-b border-slate-100 flex items-center justify-between">
                <h3 class="font-semibold text-slate-800 flex items-center gap-2">
                    <i class="fas fa-file-invoice text-blue-500"></i>
                    Facturas Pendientes
                </h3>
                <a href="{% url 'facturas_lista' %}?estado=pendiente" class="text-sm font-medium text-brand-600 hover:text-brand-700">
                    Ver todas
                </a>
            </div>
            <div class="divide-y divide-slate-100 max-h-72 overflow-y-auto">
                {% for factura in pending_invoices %}
                <div class="p-4 hover:bg-slate-50 transition">
                    <div class="flex items-center justify-between gap-3">
                        <div class="min-w-0">
                            <p class="font-medium text-slate-800 truncate">{{ factura.numero_factura }}</p>
                            <p class="text-xs text-slate-500">${{ factura.monto_total|floatformat:2 }}</p>
                        </div>
                        <span class="px-2 py-1 rounded-full text-xs font-semibold flex-shrink-0
                            {% if factura.is_overdue %}bg-red-100 text-red-700{% else %}bg-amber-100 text-amber-700{% endif %}">
                            {% if factura.is_overdue %}Vencida{% else %}Pendiente{% endif %}
                        </span>
                    </div>
                </div>
                {% empty %}
                <div class="p-6 text-center text-slate-500">
                    <i class="fas fa-check-circle text-3xl text-emerald-400 mb-2"></i>
                    <p class="text-sm">Sin facturas pendientes</p>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- Siniestros Activos -->
        <div class="bg-white rounded-2xl shadow-card border border-slate-100 overflow-hidden">
            <div class="p-5 border-b border-slate-100 flex items-center justify-between">
                <h3 class="font-semibold text-slate-800 flex items-center gap-2">
                    <i class="fas fa-car-burst text-red-500"></i>
                    Siniestros Activos
                </h3>
                <a href="{% url 'siniestros_lista' %}" class="text-sm font-medium text-brand-600 hover:text-brand-700">
                    Ver todos
                </a>
            </div>
            <div class="divide-y divide-slate-100 max-h-72 overflow-y-auto">
                {% for siniestro in active_claims %}
                <div class="p-4 hover:bg-slate-50 transition">
                    <div class="flex items-center justify-between gap-3">
                        <div class="min-w-0">
                            <p class="font-medium text-slate-800 truncate">{{ siniestro.numero_siniestro }}</p>
                            <p class="text-xs text-slate-500 truncate">{{ siniestro.bien_nombre }}</p>
                        </div>
                        <span class="px-2 py-1 rounded-full text-xs font-semibold flex-shrink-0"
                              style="background-color: {{ siniestro.state_color }}20; color: {{ siniestro.state_color }}">
                            {{ siniestro.state_label }}
                        </span>
                    </div>
                </div>
                {% empty %}
                <div class="p-6 text-center text-slate-500">
                    <i class="fas fa-check-circle text-3xl text-emerald-400 mb-2"></i>
                    <p class="text-sm">Sin siniestros activos</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Alpine.js para interactividad -->
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

<script>
// Aplicación Alpine.js para el dashboard
function dashboardApp() {
    return {
        showFilters: false,
        isLoading: false,
        datePreset: '{{ filters.date_preset }}',
        dateFrom: '{{ filters.date_from|date:"Y-m-d" }}',
        dateTo: '{{ filters.date_to|date:"Y-m-d" }}',
        selectedPresetLabel: '{{ date_presets|dictsortreversed:0|first|last }}',
        
        get dateRangeLabel() {
            if (this.datePreset === 'custom') {
                return `${this.dateFrom} - ${this.dateTo}`;
            }
            return this.selectedPresetLabel;
        },
        
        get hasActiveFilters() {
            const params = new URLSearchParams(window.location.search);
            return params.has('insurer') || params.has('broker') || params.has('policy_type') || 
                   params.has('policy_state') || params.has('q');
        },
        
        get activeFilterCount() {
            const params = new URLSearchParams(window.location.search);
            let count = 0;
            ['insurer', 'broker', 'policy_type', 'policy_state', 'claim_type', 'claim_state', 'q'].forEach(key => {
                if (params.has(key) && params.get(key)) count++;
            });
            return count;
        },
        
        selectDatePreset(preset, label) {
            this.datePreset = preset;
            this.selectedPresetLabel = label;
            
            // Actualizar el formulario y enviar
            const form = document.getElementById('filters-form');
            const hiddenInput = form.querySelector('input[name="date_preset"]');
            if (hiddenInput) {
                hiddenInput.value = preset;
            }
            
            // Si no es personalizado, enviar el formulario
            if (preset !== 'custom') {
                // Crear URL con el preset
                const params = new URLSearchParams(window.location.search);
                params.set('date_preset', preset);
                params.delete('date_from');
                params.delete('date_to');
                window.location.href = window.location.pathname + '?' + params.toString();
            }
        },
        
        clearFilters() {
            window.location.href = window.location.pathname;
        },
        
        refreshData() {
            this.isLoading = true;
            window.location.reload();
        },
        
        init() {
            // Inicializar la etiqueta del preset seleccionado
            const presets = {{ date_presets|safe }};
            if (presets && presets[this.datePreset]) {
                this.selectedPresetLabel = presets[this.datePreset];
            }
        }
    };
}
</script>

<script src="{% static 'js/dashboard-charts-v2.js' %}"></script>
{% endblock %}

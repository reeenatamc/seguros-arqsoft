{% extends 'app/layouts/base.html' %}
{% load static %}

{% block title %}Reporte de Siniestralidad{% endblock %}

{% block content %}
<div class="space-y-6 animate-fade-in">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
            <h1 class="text-2xl font-bold text-slate-800">Reporte de Siniestralidad</h1>
            <p class="text-slate-500 mt-1">Análisis del índice de siniestralidad y tendencias</p>
        </div>
        <div class="flex items-center gap-3">
            <a href="?{% if fecha_desde %}fecha_desde={{ fecha_desde|date:'Y-m-d' }}&{% endif %}{% if fecha_hasta %}fecha_hasta={{ fecha_hasta|date:'Y-m-d' }}&{% endif %}{% if compania_seleccionada %}compania={{ compania_seleccionada }}&{% endif %}formato=pdf"
               class="inline-flex items-center gap-2 px-4 py-2.5 bg-red-600 text-white rounded-xl hover:bg-red-700 transition font-medium text-sm">
                <i class="fas fa-file-pdf"></i>
                Exportar PDF
            </a>
            <a href="?{% if fecha_desde %}fecha_desde={{ fecha_desde|date:'Y-m-d' }}&{% endif %}{% if fecha_hasta %}fecha_hasta={{ fecha_hasta|date:'Y-m-d' }}&{% endif %}{% if compania_seleccionada %}compania={{ compania_seleccionada }}&{% endif %}formato=excel"
               class="inline-flex items-center gap-2 px-4 py-2.5 bg-emerald-600 text-white rounded-xl hover:bg-emerald-700 transition font-medium text-sm">
                <i class="fas fa-file-excel"></i>
                Exportar Excel
            </a>
        </div>
    </div>

    <!-- Filtros -->
    <div class="bg-white rounded-2xl shadow-card border border-slate-100 p-4">
        <form method="GET" class="flex flex-wrap gap-4">
            <div class="date-input-wrapper relative">
                <i class="fas fa-calendar-alt absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs pointer-events-none z-10"></i>
                <input type="date" name="fecha_desde" value="{{ fecha_desde|date:'Y-m-d' }}"
                       class="pl-9 pr-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:bg-white focus:border-brand-500 focus:ring-1 focus:ring-brand-500/20 transition-all w-48"
                       placeholder="Desde" title="Fecha desde">
            </div>
            <div class="date-input-wrapper relative">
                <i class="fas fa-calendar-alt absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs pointer-events-none z-10"></i>
                <input type="date" name="fecha_hasta" value="{{ fecha_hasta|date:'Y-m-d' }}"
                       class="pl-9 pr-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:bg-white focus:border-brand-500 focus:ring-1 focus:ring-brand-500/20 transition-all w-48"
                       placeholder="Hasta" title="Fecha hasta">
            </div>
            <select name="compania" class="px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm">
                <option value="">Todas las compañías</option>
                {% for compania in companias %}
                    <option value="{{ compania.id }}" {% if compania_seleccionada == compania.id|stringformat:"s" %}selected{% endif %}>{{ compania.nombre }}</option>
                {% endfor %}
            </select>
            <button type="submit" class="px-4 py-2.5 bg-brand-600 text-white rounded-xl hover:bg-brand-700 transition text-sm font-medium">
                <i class="fas fa-filter mr-2"></i>Aplicar
            </button>
            {% if compania_seleccionada or fecha_desde or fecha_hasta %}
                <a href="{% url 'reporte_siniestralidad' %}" class="px-4 py-2.5 bg-slate-100 text-slate-600 rounded-xl hover:bg-slate-200 transition text-sm font-medium">
                    Limpiar
                </a>
            {% endif %}
        </form>
    </div>

    <!-- KPIs principales -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="bg-gradient-to-br from-purple-500 to-purple-700 rounded-2xl p-5 text-white">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                    <i class="fas fa-percent text-xl"></i>
                </div>
                <div>
                    <p class="text-sm text-white/70">Índice de Siniestralidad</p>
                    <p class="text-2xl font-bold">{{ datos.totales.indice_siniestralidad|floatformat:2 }}%</p>
                </div>
            </div>
        </div>
        <div class="bg-gradient-to-br from-emerald-500 to-emerald-700 rounded-2xl p-5 text-white">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                    <i class="fas fa-coins text-xl"></i>
                </div>
                <div>
                    <p class="text-sm text-white/70">Primas Pagadas</p>
                    <p class="text-2xl font-bold">${{ datos.totales.primas_pagadas|floatformat:0 }}</p>
                </div>
            </div>
        </div>
        <div class="bg-gradient-to-br from-red-500 to-red-700 rounded-2xl p-5 text-white">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                    <i class="fas fa-hand-holding-dollar text-xl"></i>
                </div>
                <div>
                    <p class="text-sm text-white/70">Siniestros Pagados</p>
                    <p class="text-2xl font-bold">${{ datos.totales.siniestros_pagados|floatformat:0 }}</p>
                </div>
            </div>
        </div>
        <div class="bg-gradient-to-br from-{% if datos.interpretacion.color == 'green' %}emerald{% elif datos.interpretacion.color == 'blue' %}blue{% elif datos.interpretacion.color == 'yellow' %}amber{% elif datos.interpretacion.color == 'orange' %}orange{% else %}red{% endif %}-500 to-{% if datos.interpretacion.color == 'green' %}emerald{% elif datos.interpretacion.color == 'blue' %}blue{% elif datos.interpretacion.color == 'yellow' %}amber{% elif datos.interpretacion.color == 'orange' %}orange{% else %}red{% endif %}-700 rounded-2xl p-5 text-white">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                    <i class="fas fa-chart-line text-xl"></i>
                </div>
                <div>
                    <p class="text-sm text-white/70">Nivel</p>
                    <p class="text-xl font-bold capitalize">{{ datos.interpretacion.nivel }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Mensaje de interpretación -->
    <div class="bg-{% if datos.interpretacion.color == 'green' %}emerald{% elif datos.interpretacion.color == 'blue' %}blue{% elif datos.interpretacion.color == 'yellow' %}amber{% elif datos.interpretacion.color == 'orange' %}orange{% else %}red{% endif %}-50 border border-{% if datos.interpretacion.color == 'green' %}emerald{% elif datos.interpretacion.color == 'blue' %}blue{% elif datos.interpretacion.color == 'yellow' %}amber{% elif datos.interpretacion.color == 'orange' %}orange{% else %}red{% endif %}-200 rounded-xl p-4">
        <div class="flex items-start gap-3">
            <i class="fas fa-info-circle text-{% if datos.interpretacion.color == 'green' %}emerald{% elif datos.interpretacion.color == 'blue' %}blue{% elif datos.interpretacion.color == 'yellow' %}amber{% elif datos.interpretacion.color == 'orange' %}orange{% else %}red{% endif %}-600 text-xl mt-0.5"></i>
            <div>
                <h4 class="font-semibold text-{% if datos.interpretacion.color == 'green' %}emerald{% elif datos.interpretacion.color == 'blue' %}blue{% elif datos.interpretacion.color == 'yellow' %}amber{% elif datos.interpretacion.color == 'orange' %}orange{% else %}red{% endif %}-800">Interpretación</h4>
                <p class="text-{% if datos.interpretacion.color == 'green' %}emerald{% elif datos.interpretacion.color == 'blue' %}blue{% elif datos.interpretacion.color == 'yellow' %}amber{% elif datos.interpretacion.color == 'orange' %}orange{% else %}red{% endif %}-700 mt-1">{{ datos.interpretacion.mensaje }}</p>
            </div>
        </div>
    </div>

    <!-- Gráfico de tendencia mensual -->
    <div class="bg-white rounded-2xl shadow-card border border-slate-100 overflow-hidden">
        <div class="p-5 border-b border-slate-100">
            <h3 class="font-semibold text-slate-800">Tendencia Mensual de Siniestralidad</h3>
            <p class="text-sm text-slate-500 mt-1">Evolución del índice durante el período seleccionado</p>
        </div>
        <div class="p-5">
            <canvas id="siniestralidad-chart" height="100"></canvas>
        </div>
    </div>

    <!-- Tabla de detalle mensual -->
    <div class="bg-white rounded-2xl shadow-card border border-slate-100 overflow-hidden">
        <div class="p-5 border-b border-slate-100">
            <h3 class="font-semibold text-slate-800">Detalle Mensual</h3>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="bg-slate-50 border-b border-slate-200">
                        <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase">Mes</th>
                        <th class="px-4 py-3 text-right text-xs font-semibold text-slate-600 uppercase">Primas Pagadas</th>
                        <th class="px-4 py-3 text-right text-xs font-semibold text-slate-600 uppercase">Siniestros Pagados</th>
                        <th class="px-4 py-3 text-right text-xs font-semibold text-slate-600 uppercase">Índice</th>
                        <th class="px-4 py-3 text-center text-xs font-semibold text-slate-600 uppercase">Estado</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-100">
                    {% for mes in datos.detalle_mensual %}
                    <tr class="hover:bg-slate-50/50">
                        <td class="px-4 py-3 font-medium text-slate-800">{{ mes.mes_nombre }}</td>
                        <td class="px-4 py-3 text-right text-slate-700">${{ mes.primas_pagadas|floatformat:2 }}</td>
                        <td class="px-4 py-3 text-right text-slate-700">${{ mes.siniestros_pagados|floatformat:2 }}</td>
                        <td class="px-4 py-3 text-right font-semibold text-slate-800">{{ mes.indice|floatformat:2 }}%</td>
                        <td class="px-4 py-3 text-center">
                            {% if mes.indice < 30 %}
                                <span class="inline-flex px-2.5 py-1 rounded-full text-xs font-semibold bg-emerald-100 text-emerald-700">Excelente</span>
                            {% elif mes.indice < 50 %}
                                <span class="inline-flex px-2.5 py-1 rounded-full text-xs font-semibold bg-blue-100 text-blue-700">Bueno</span>
                            {% elif mes.indice < 70 %}
                                <span class="inline-flex px-2.5 py-1 rounded-full text-xs font-semibold bg-amber-100 text-amber-700">Moderado</span>
                            {% elif mes.indice < 100 %}
                                <span class="inline-flex px-2.5 py-1 rounded-full text-xs font-semibold bg-orange-100 text-orange-700">Alto</span>
                            {% else %}
                                <span class="inline-flex px-2.5 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-700">Crítico</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="px-4 py-12 text-center text-slate-500">No hay datos para mostrar</td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot class="bg-slate-50 border-t-2 border-slate-200">
                    <tr>
                        <td class="px-4 py-3 font-bold text-slate-800">TOTAL</td>
                        <td class="px-4 py-3 text-right font-bold text-slate-800">${{ datos.totales.primas_pagadas|floatformat:2 }}</td>
                        <td class="px-4 py-3 text-right font-bold text-slate-800">${{ datos.totales.siniestros_pagados|floatformat:2 }}</td>
                        <td class="px-4 py-3 text-right font-bold text-purple-600">{{ datos.totales.indice_siniestralidad|floatformat:2 }}%</td>
                        <td class="px-4 py-3"></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('siniestralidad-chart');
    if (ctx) {
        const detalleMensual = {{ datos.detalle_mensual|safe }};
        const labels = detalleMensual.map(d => d.mes_nombre);
        const indices = detalleMensual.map(d => d.indice);
        const primas = detalleMensual.map(d => d.primas_pagadas);
        const siniestros = detalleMensual.map(d => d.siniestros_pagados);

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Índice de Siniestralidad (%)',
                        data: indices,
                        borderColor: 'rgb(147, 51, 234)',
                        backgroundColor: 'rgba(147, 51, 234, 0.1)',
                        tension: 0.3,
                        yAxisID: 'y',
                    },
                    {
                        label: 'Primas Pagadas',
                        data: primas,
                        borderColor: 'rgb(16, 185, 129)',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.3,
                        yAxisID: 'y1',
                        hidden: true
                    },
                    {
                        label: 'Siniestros Pagados',
                        data: siniestros,
                        borderColor: 'rgb(239, 68, 68)',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.3,
                        yAxisID: 'y1',
                        hidden: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.datasetIndex === 0) {
                                    label += context.parsed.y.toFixed(2) + '%';
                                } else {
                                    label += '$' + context.parsed.y.toLocaleString();
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Índice (%)'
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Monto ($)'
                        },
                        grid: {
                            drawOnChartArea: false,
                        },
                    },
                }
            }
        });
    }
});
</script>
{% endblock %}

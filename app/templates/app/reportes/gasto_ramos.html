{% extends 'app/layouts/base.html' %}
{% load static %}

{% block title %}Reporte de Gastos por Ramos{% endblock %}

{% block content %}
<div class="space-y-6 animate-fade-in">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
            <h1 class="text-2xl font-bold text-slate-800">Reporte de Gastos por Ramos</h1>
            <p class="text-slate-500 mt-1">Análisis detallado de primas y coberturas por ramo</p>
        </div>
        <div class="flex items-center gap-3">
            <a href="?{% if fecha_desde %}fecha_desde={{ fecha_desde|date:'Y-m-d' }}&{% endif %}{% if fecha_hasta %}fecha_hasta={{ fecha_hasta|date:'Y-m-d' }}&{% endif %}formato=pdf"
               class="inline-flex items-center gap-2 px-4 py-2.5 bg-red-600 text-white rounded-xl hover:bg-red-700 transition font-medium text-sm">
                <i class="fas fa-file-pdf"></i>
                Exportar PDF
            </a>
            <a href="?{% if fecha_desde %}fecha_desde={{ fecha_desde|date:'Y-m-d' }}&{% endif %}{% if fecha_hasta %}fecha_hasta={{ fecha_hasta|date:'Y-m-d' }}&{% endif %}formato=excel"
               class="inline-flex items-center gap-2 px-4 py-2.5 bg-emerald-600 text-white rounded-xl hover:bg-emerald-700 transition font-medium text-sm">
                <i class="fas fa-file-excel"></i>
                Exportar Excel
            </a>
        </div>
    </div>

    <!-- Filtros -->
    <div class="bg-white rounded-2xl shadow-card border border-slate-100 p-4">
        <form method="GET" class="flex flex-wrap gap-4">
            <div class="date-input-wrapper relative">
                <i class="fas fa-calendar-alt absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs pointer-events-none z-10"></i>
                <input type="date" name="fecha_desde" value="{{ fecha_desde|date:'Y-m-d' }}"
                       class="pl-9 pr-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:bg-white focus:border-brand-500 focus:ring-1 focus:ring-brand-500/20 transition-all w-48"
                       placeholder="Desde" title="Fecha desde">
            </div>
            <div class="date-input-wrapper relative">
                <i class="fas fa-calendar-alt absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs pointer-events-none z-10"></i>
                <input type="date" name="fecha_hasta" value="{{ fecha_hasta|date:'Y-m-d' }}"
                       class="pl-9 pr-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:bg-white focus:border-brand-500 focus:ring-1 focus:ring-brand-500/20 transition-all w-48"
                       placeholder="Hasta" title="Fecha hasta">
            </div>
            <button type="submit" class="px-4 py-2.5 bg-brand-600 text-white rounded-xl hover:bg-brand-700 transition text-sm font-medium">
                <i class="fas fa-filter mr-2"></i>Aplicar
            </button>
            {% if fecha_desde or fecha_hasta %}
                <a href="{% url 'reporte_gasto_ramos' %}" class="px-4 py-2.5 bg-slate-100 text-slate-600 rounded-xl hover:bg-slate-200 transition text-sm font-medium">
                    Limpiar
                </a>
            {% endif %}
        </form>
    </div>

    <!-- KPIs principales -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="bg-white rounded-xl p-4 border border-slate-100 shadow-card">
            <p class="text-sm text-slate-500">Total Ramos</p>
            <p class="text-2xl font-bold text-slate-800 mt-1">{{ datos.cantidad_ramos|default:0 }}</p>
        </div>
        <div class="bg-brand-50 rounded-xl p-4 border border-brand-100">
            <p class="text-sm text-brand-600">Suma Asegurada</p>
            <p class="text-xl font-bold text-brand-700 mt-1">${{ datos.totales.suma_asegurada|floatformat:0 }}</p>
        </div>
        <div class="bg-emerald-50 rounded-xl p-4 border border-emerald-100">
            <p class="text-sm text-emerald-600">Total Prima</p>
            <p class="text-xl font-bold text-emerald-700 mt-1">${{ datos.totales.total_prima|floatformat:0 }}</p>
        </div>
        <div class="bg-purple-50 rounded-xl p-4 border border-purple-100">
            <p class="text-sm text-purple-600">Valor por Pagar</p>
            <p class="text-xl font-bold text-purple-700 mt-1">${{ datos.totales.valor_por_pagar|floatformat:0 }}</p>
        </div>
    </div>

    <!-- Gráfico de distribución -->
    <div class="bg-white rounded-2xl shadow-card border border-slate-100 overflow-hidden">
        <div class="p-5 border-b border-slate-100">
            <h3 class="font-semibold text-slate-800">Distribución de Primas por Ramo</h3>
            <p class="text-sm text-slate-500 mt-1">Porcentaje de participación de cada ramo</p>
        </div>
        <div class="p-5">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div>
                    <canvas id="ramos-chart" height="300"></canvas>
                </div>
                <div class="space-y-2">
                    <h4 class="text-sm font-semibold text-slate-700 mb-3">Top Ramos por Prima</h4>
                    {% for ramo in datos.ramos|slice:":5" %}
                        <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                            <div class="flex items-center gap-3">
                                <div class="w-3 h-3 rounded-full" style="background-color: {{ ramo.color|default:'rgb(99, 102, 241)' }}"></div>
                                <div>
                                    <p class="font-medium text-slate-800 text-sm">{{ ramo.nombre }}</p>
                                    <p class="text-xs text-slate-500">{{ ramo.codigo }}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="font-semibold text-slate-800 text-sm">${{ ramo.total_prima|floatformat:0 }}</p>
                                <p class="text-xs text-slate-500">{{ ramo.porcentaje_prima|floatformat:1 }}%</p>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de detalle -->
    <div class="bg-white rounded-2xl shadow-card border border-slate-100 overflow-hidden">
        <div class="p-5 border-b border-slate-100">
            <h3 class="font-semibold text-slate-800">Detalle por Ramo</h3>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="bg-slate-50 border-b border-slate-200">
                        <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase">Código</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase">Nombre</th>
                        <th class="px-4 py-3 text-center text-xs font-semibold text-slate-600 uppercase">Pólizas</th>
                        <th class="px-4 py-3 text-right text-xs font-semibold text-slate-600 uppercase">Suma Asegurada</th>
                        <th class="px-4 py-3 text-right text-xs font-semibold text-slate-600 uppercase">Prima</th>
                        <th class="px-4 py-3 text-right text-xs font-semibold text-slate-600 uppercase">Contribuciones</th>
                        <th class="px-4 py-3 text-right text-xs font-semibold text-slate-600 uppercase">IVA</th>
                        <th class="px-4 py-3 text-right text-xs font-semibold text-slate-600 uppercase">Retenciones</th>
                        <th class="px-4 py-3 text-right text-xs font-semibold text-slate-600 uppercase">Total Facturado</th>
                        <th class="px-4 py-3 text-right text-xs font-semibold text-slate-600 uppercase">Por Pagar</th>
                        <th class="px-4 py-3 text-center text-xs font-semibold text-slate-600 uppercase">% Prima</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-100">
                    {% for ramo in datos.ramos %}
                    <tr class="hover:bg-slate-50/50">
                        <td class="px-4 py-3 font-medium text-slate-800">{{ ramo.codigo }}</td>
                        <td class="px-4 py-3 text-slate-700">{{ ramo.nombre }}</td>
                        <td class="px-4 py-3 text-center text-slate-600">{{ ramo.cantidad_polizas }}</td>
                        <td class="px-4 py-3 text-right text-slate-700">${{ ramo.suma_asegurada|floatformat:2 }}</td>
                        <td class="px-4 py-3 text-right font-medium text-slate-800">${{ ramo.total_prima|floatformat:2 }}</td>
                        <td class="px-4 py-3 text-right text-slate-700">${{ ramo.total_contribuciones|floatformat:2 }}</td>
                        <td class="px-4 py-3 text-right text-slate-700">${{ ramo.total_iva|floatformat:2 }}</td>
                        <td class="px-4 py-3 text-right text-slate-700">${{ ramo.total_retenciones|floatformat:2 }}</td>
                        <td class="px-4 py-3 text-right font-medium text-slate-800">${{ ramo.total_facturado|floatformat:2 }}</td>
                        <td class="px-4 py-3 text-right font-semibold text-brand-600">${{ ramo.valor_por_pagar|floatformat:2 }}</td>
                        <td class="px-4 py-3 text-center">
                            <span class="inline-flex px-2.5 py-1 rounded-full text-xs font-semibold bg-brand-100 text-brand-700">
                                {{ ramo.porcentaje_prima|floatformat:1 }}%
                            </span>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="11" class="px-4 py-12 text-center text-slate-500">No hay datos para mostrar</td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot class="bg-slate-50 border-t-2 border-slate-200">
                    <tr>
                        <td colspan="3" class="px-4 py-3 font-bold text-slate-800">TOTAL</td>
                        <td class="px-4 py-3 text-right font-bold text-slate-800">${{ datos.totales.suma_asegurada|floatformat:2 }}</td>
                        <td class="px-4 py-3 text-right font-bold text-slate-800">${{ datos.totales.total_prima|floatformat:2 }}</td>
                        <td class="px-4 py-3 text-right font-bold text-slate-800">${{ datos.totales.total_contribuciones|floatformat:2 }}</td>
                        <td class="px-4 py-3 text-right font-bold text-slate-800">${{ datos.totales.total_iva|floatformat:2 }}</td>
                        <td class="px-4 py-3 text-right font-bold text-slate-800">${{ datos.totales.total_retenciones|floatformat:2 }}</td>
                        <td class="px-4 py-3 text-right font-bold text-slate-800">${{ datos.totales.total_facturado|floatformat:2 }}</td>
                        <td class="px-4 py-3 text-right font-bold text-brand-600">${{ datos.totales.valor_por_pagar|floatformat:2 }}</td>
                        <td class="px-4 py-3 text-center font-bold text-slate-800">100%</td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('ramos-chart');
    if (ctx) {
        const ramos = {{ datos.ramos|safe }};
        const labels = ramos.map(r => r.nombre);
        const data = ramos.map(r => r.total_prima);

        // Generate colors
        const colors = [
            'rgb(99, 102, 241)',   // Indigo
            'rgb(16, 185, 129)',   // Emerald
            'rgb(251, 146, 60)',   // Orange
            'rgb(147, 51, 234)',   // Purple
            'rgb(236, 72, 153)',   // Pink
            'rgb(14, 165, 233)',   // Sky
            'rgb(245, 158, 11)',   // Amber
            'rgb(59, 130, 246)',   // Blue
            'rgb(239, 68, 68)',    // Red
            'rgb(20, 184, 166)',   // Teal
        ];

        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: colors,
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return `${label}: $${value.toLocaleString()} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }
});
</script>
{% endblock %}
